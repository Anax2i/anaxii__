name: osu-wiki continuous integration

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - reopened
      - synchronize
      - edited

jobs:
  setup_repository:
    name: Repository checkout
    runs-on: ubuntu-latest
    steps:
      - name: Clone the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect changed files
        run: |
          INTERESTING_FILES=$(
            sort -u < <(
              # Changes that are not committed (staged + unstaged + untracked), but without deleted files
              git status --short -v -v --no-renames --porcelain | awk '$1 != "D" { print $2 }'
              # Changes committed so far (may overlap with the above)
              git diff --no-renames --name-only --diff-filter=d ${{ github.sha }}^
            )
          )

          # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#multiline-strings
          # XXX: env.INTERESTING_FILES will be a single string with newline delimiters.
          DELIMITER="X${RANDOM}"
          echo "INTERESTING_FILES<<${DELIMITER}" >> $GITHUB_ENV
          echo "${INTERESTING_FILES}" >> $GITHUB_ENV
          echo "${DELIMITER}" >> $GITHUB_ENV

  setup_nodejs_deps:
    name: Setup Node.js dependencies
    runs-on: ubuntu-latest
    needs: setup_repository
    steps:
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          cache: npm
          node-version: 16

      - name: Install Markdown linter
        run: npm ci

  setup_python_deps:
    name: Setup Python dependencies
    runs-on: ubuntu-latest
    needs: setup_repository
    steps:
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          cache: pip
          cache-dependency-path: scripts/requirements.txt
          python-version: 3.x

      - name: Install Python packages
        run: pip install -r scripts/requirements.txt

  check_file_sizes:
    name: Inspect file sizes
    runs-on: ubuntu-latest
    needs: setup_repository
    steps:
      - name: Inspect file sizes
        shell: bash
        run: |
          readarray -t TARGET_FILES <<< "${{ env.INTERESTING_FILES }}"
          bash scripts/ci/inspect_file_sizes.sh --target "${TARGET_FILES[@]}"

  check_markdown_style:
    name: Check article style
    runs-on: ubuntu-latest
    needs: setup_nodejs_deps
    steps:
      - name: Check Markdown style
        run: |
          readarray -t REMARK_TARGET_FILES <<< $( echo "${{ env.INTERESTING_FILES }}" | grep -e .md$ || true )
          bash scripts/ci/run_remark.sh --target "${REMARK_TARGET_FILES[@]}"

  check_yaml:
    name: Check front matter and YAML correctness
    runs-on: ubuntu-latest
    needs: setup_python_deps
    steps:
      - name: Run yamllint on .yaml and .md files
        run: |
          readarray -t YAMLLINT_TARGET_FILES <<< $( echo "${{ env.INTERESTING_FILES }}" | grep -e .yaml$ -e .yml$ -e .md$ || true )
          python scripts/ci/run_yamllint.py --config .yamllint.yaml --target "${YAMLLINT_TARGET_FILES[@]}"

  check_links:
    name: Check links
    runs-on: ubuntu-latest
    needs: setup_python_deps
    steps:
      - name: Find broken wikilinks
        shell: bash
        env:
          PULL_REQUEST_TAG: 'SKIP_WIKILINK_CHECK'
        run: |
          if ${{ contains(github.event.pull_request.body, env.PULL_REQUEST_TAG) }}; then
            echo "::notice::Broken wikilink check suppressed ($PULL_REQUEST_TAG tag found in the pull request)"
            exit 0
          fi

          readarray -t WIKILINK_TARGET_FILES <<< $( echo "${{ env.INTERESTING_FILES }}" | grep -e ^wiki/ -e ^news/ | grep .md$ || true )
          osu-wiki-tools check-links --target "${WIKILINK_TARGET_FILES[@]}"

  check_outdated_markers:
    name: Check article freshness
    runs-on: ubuntu-latest
    needs: setup_python_deps
    steps:
      - name: Check if translations are marked as outdated
        shell: bash
        env:
          PULL_REQUEST_TAG: 'SKIP_OUTDATED_CHECK'
        run: |
          if ${{ contains(github.event.pull_request.body, env.PULL_REQUEST_TAG) }}; then
            echo "::notice::Outdated articles check suppressed ($PULL_REQUEST_TAG tag found in the pull request)"
            exit 0
          fi
          # get the first commit of the branch associated with the PR; GitHub's ubuntu-latest has curl/jq: https://github.com/actions/virtual-environments
          FIRST_PR_COMMIT_HASH=$( curl -sS ${{ github.event.pull_request.commits_url }}?per_page=1 | jq -r '.[0].sha' || true )
          osu-wiki-tools check-outdated-articles --workflow --base-commit ${{ github.sha }} --outdated-since $FIRST_PR_COMMIT_HASH
